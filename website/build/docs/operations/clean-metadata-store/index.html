<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-operations/clean-metadata-store">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.22">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-131010415-1"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-131010415-1",{})</script>


<link rel="search" type="application/opensearchdescription+xml" title="Apache Druid" href="/opensearch.xml">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css">
<link rel="stylesheet" href="/css/code-block-buttons.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js"></script>
<script src="/js/code-block-buttons.js"></script><title data-rh="true">Automated cleanup for metadata records | Apache Druid</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://druid.apache.org/img/druid_nav.png"><meta data-rh="true" name="twitter:image" content="https://druid.apache.org/img/druid_nav.png"><meta data-rh="true" property="og:url" content="https://druid.apache.org/docs/operations/clean-metadata-store"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Automated cleanup for metadata records | Apache Druid"><meta data-rh="true" name="description" content="Defines a strategy to maintain Druid metadata store performance by automatically removing leftover records for deleted entities: datasources, supervisors, rules, compaction configuration, audit records, etc. Most applicable to databases with &#x27;high-churn&#x27; datasources."><meta data-rh="true" property="og:description" content="Defines a strategy to maintain Druid metadata store performance by automatically removing leftover records for deleted entities: datasources, supervisors, rules, compaction configuration, audit records, etc. Most applicable to databases with &#x27;high-churn&#x27; datasources."><link data-rh="true" rel="icon" href="/img/favicon.png"><link data-rh="true" rel="canonical" href="https://druid.apache.org/docs/operations/clean-metadata-store"><link data-rh="true" rel="alternate" href="https://druid.apache.org/docs/operations/clean-metadata-store" hreflang="en"><link data-rh="true" rel="alternate" href="https://druid.apache.org/docs/operations/clean-metadata-store" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://CPK9PMSCEY-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.f9da320f.css">
<link rel="preload" href="/assets/js/runtime~main.48cb3551.js" as="script">
<link rel="preload" href="/assets/js/main.fe95e508.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/druid_nav.png" alt="" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/druid_nav.png" alt="" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Apache Druid</b></a><a class="navbar__item navbar__link" href="/technology">Technology</a><a class="navbar__item navbar__link" href="/use-cases">Use Cases</a><a class="navbar__item navbar__link" href="/druid-powered">Powered By</a><a class="navbar__item navbar__link" href="/docs/design/index">Docs</a><a class="navbar__item navbar__link" href="/community/">Community</a><a href="https://www.apache.org" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Apache<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a class="navbar__item navbar__link" href="/downloads.html">Download</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/design/">Getting started</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/tutorials/tutorial-batch">Tutorials</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/design/architecture">Design</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/ingestion/">Ingestion</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/data-management/">Data management</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/querying/sql">Querying</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/configuration/">Configuration</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/operations/web-console">Operations</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/operations/web-console">Web console</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/operations/java">Java runtime</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/operations/security-overview">Security</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/docs/operations/basic-cluster-tuning">Performance tuning</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/operations/basic-cluster-tuning">Basic cluster tuning</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/operations/segment-optimization">Segment size optimization</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/operations/mixed-workloads">Mixed workloads</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/operations/http-compression">HTTP compression</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/operations/clean-metadata-store">Automated metadata cleanup</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/operations/request-logging">Monitoring</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/operations/api-reference">API reference</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/operations/high-availability">High availability</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/operations/rolling-updates">Rolling updates</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/operations/rule-configuration">Using rules to drop and retain data</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/operations/other-hadoop">Working with different versions of Apache Hadoop</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/operations/dump-segment">Misc</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/development/overview">Development</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/misc/papers-and-talks">Misc</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/comparisons/druid-vs-elasticsearch">Hidden</a></div></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Operations</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Performance tuning</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Automated metadata cleanup</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Automated cleanup for metadata records</h1></header><p>Apache Druid relies on <a href="/docs/dependencies/metadata-storage">metadata storage</a> to track information on data storage, operations, and system configuration.
The metadata store includes the following:</p><ul><li>Segment records</li><li>Audit records</li><li>Supervisor records</li><li>Rule records</li><li>Compaction configuration records</li><li>Datasource records created by supervisors</li><li>Indexer task logs</li></ul><p>When you delete some entities from Apache Druid, records related to the entity may remain in the metadata store.
If you have a high datasource churn rate, meaning you frequently create and delete many short-lived datasources or other related entities like compaction configuration or rules, the leftover records can fill your metadata store and cause performance issues.
To maintain metadata store performance, you can configure Apache Druid to automatically remove records associated with deleted entities from the metadata store.</p><p>By default, Druid automatically cleans up metadata older than 90 days.
This applies to all metadata entities in this topic except compaction configuration records and indexer task logs, for which cleanup is disabled by default.
You can configure the retention period for each metadata type, when available, through the record&#x27;s <code>durationToRetain</code> property.
Certain records may require additional conditions be satisfied before clean up occurs.</p><p>See the <a href="#example">example</a> for how you can customize the automated metadata cleanup for a specific use case.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="automated-cleanup-strategies">Automated cleanup strategies<a class="hash-link" href="#automated-cleanup-strategies" title="Direct link to heading">​</a></h2><p>There are several cases when you should consider automated cleanup of the metadata related to deleted datasources:</p><ul><li>If you know you have many high-churn datasources, for example, you have scripts that create and delete supervisors regularly.</li><li>If you have issues with the hard disk for your metadata database filling up.</li><li>If you run into performance issues with the metadata database. For example, API calls are very slow or fail to execute.</li></ul><p>If you have compliance requirements to keep audit records and you enable automated cleanup for audit records, use alternative methods to preserve audit metadata, for example, by periodically exporting audit metadata records to external storage.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="configure-automated-metadata-cleanup">Configure automated metadata cleanup<a class="hash-link" href="#configure-automated-metadata-cleanup" title="Direct link to heading">​</a></h2><p>You can configure cleanup for each entity separately, as described in this section.
Define the properties in the <code>coordinator/runtime.properties</code> file.</p><p>The cleanup of one entity may depend on the cleanup of another entity as follows:</p><ul><li>You have to configure a <a href="#kill-task">kill task for segment records</a> before you can configure automated cleanup for <a href="#rules-records">rules</a> or <a href="#compaction-configuration-records">compaction configuration</a>.</li><li>You have to schedule the metadata management tasks to run at the same or higher frequency as your most frequent cleanup job. For example, if your most frequent cleanup job is every hour, set the metadata store management period to one hour or less: <code>druid.coordinator.period.metadataStoreManagementPeriod=P1H</code>.</li></ul><p>For details on configuration properties, see <a href="/docs/configuration/#metadata-management">Metadata management</a>.
If you want to skip the details, check out the <a href="#example">example</a> for configuring automated metadata cleanup.</p><a name="kill-task"></a>### Segment records and segments in deep storage (kill task)<blockquote><p>The kill task is the only configuration in this topic that affects actual data in deep storage and not simply metadata or logs.</p></blockquote><p>Segment records and segments in deep storage become eligible for deletion when both of the following conditions hold:</p><ul><li>When they meet the eligibility requirement of kill task datasource configuration according to <code>killDataSourceWhitelist</code> set in the Coordinator dynamic configuration. See <a href="/docs/configuration/#dynamic-configuration">Dynamic configuration</a>.</li><li>When the <code>durationToRetain</code> time has passed since their creation.</li></ul><p>Kill tasks use the following configuration:</p><ul><li><code>druid.coordinator.kill.on</code>: When <code>true</code>, enables the Coordinator to submit a kill task for unused segments, which deletes them completely from metadata store and from deep storage.
Only applies to the specified datasources in the dynamic configuration parameter <code>killDataSourceWhitelist</code>.
If <code>killDataSourceWhitelist</code> is not set or empty, then kill tasks can be submitted for all datasources.</li><li><code>druid.coordinator.kill.period</code>: Defines the frequency in <a href="https://en.wikipedia.org/wiki/ISO_8601#Durations" target="_blank" rel="noopener noreferrer">ISO 8601 format</a> for the cleanup job to check for and delete eligible segments. Defaults to <code>P1D</code>. Must be greater than <code>druid.coordinator.period.indexingPeriod</code>. </li><li><code>druid.coordinator.kill.durationToRetain</code>: Defines the retention period in <a href="https://en.wikipedia.org/wiki/ISO_8601#Durations" target="_blank" rel="noopener noreferrer">ISO 8601 format</a> after creation that segments become eligible for deletion.</li><li><code>druid.coordinator.kill.maxSegments</code>: Defines the maximum number of segments to delete per kill task.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="audit-records">Audit records<a class="hash-link" href="#audit-records" title="Direct link to heading">​</a></h3><p>All audit records become eligible for deletion when the <code>durationToRetain</code> time has passed since their creation.</p><p>Audit cleanup uses the following configuration:</p><ul><li><code>druid.coordinator.kill.audit.on</code>: When <code>true</code>, enables cleanup for audit records.</li><li><code>druid.coordinator.kill.audit.period</code>: Defines the frequency in <a href="https://en.wikipedia.org/wiki/ISO_8601#Durations" target="_blank" rel="noopener noreferrer">ISO 8601 format</a> for the cleanup job to check for and delete eligible audit records. Defaults to <code>P1D</code>.</li><li><code>druid.coordinator.kill.audit.durationToRetain</code>: Defines the retention period in <a href="https://en.wikipedia.org/wiki/ISO_8601#Durations" target="_blank" rel="noopener noreferrer">ISO 8601 format</a> after creation that audit records become eligible for deletion.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="supervisor-records">Supervisor records<a class="hash-link" href="#supervisor-records" title="Direct link to heading">​</a></h3><p>Supervisor records become eligible for deletion when the supervisor is terminated and the <code>durationToRetain</code> time has passed since their creation.</p><p>Supervisor cleanup uses the following configuration:</p><ul><li><code>druid.coordinator.kill.supervisor.on</code>: When <code>true</code>, enables cleanup for supervisor records.</li><li><code>druid.coordinator.kill.supervisor.period</code>: Defines the frequency in <a href="https://en.wikipedia.org/wiki/ISO_8601#Durations" target="_blank" rel="noopener noreferrer">ISO 8601 format</a> for the cleanup job to check for and delete eligible supervisor records. Defaults to <code>P1D</code>.</li><li><code>druid.coordinator.kill.supervisor.durationToRetain</code>: Defines the retention period in <a href="https://en.wikipedia.org/wiki/ISO_8601#Durations" target="_blank" rel="noopener noreferrer">ISO 8601 format</a> after creation that supervisor records become eligible for deletion.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="rules-records">Rules records<a class="hash-link" href="#rules-records" title="Direct link to heading">​</a></h3><p>Rule records become eligible for deletion when all segments for the datasource have been killed by the kill task and the <code>durationToRetain</code> time has passed since their creation. Automated cleanup for rules requires a <a href="#kill-task">kill task</a>.</p><p>Rule cleanup uses the following configuration:</p><ul><li><code>druid.coordinator.kill.rule.on</code>: When <code>true</code>, enables cleanup for rules records.</li><li><code>druid.coordinator.kill.rule.period</code>: Defines the frequency in <a href="https://en.wikipedia.org/wiki/ISO_8601#Durations" target="_blank" rel="noopener noreferrer">ISO 8601 format</a> for the cleanup job to check for and delete eligible rules records. Defaults to <code>P1D</code>.</li><li><code>druid.coordinator.kill.rule.durationToRetain</code>: Defines the retention period in <a href="https://en.wikipedia.org/wiki/ISO_8601#Durations" target="_blank" rel="noopener noreferrer">ISO 8601 format</a> after creation that rules records become eligible for deletion.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="compaction-configuration-records">Compaction configuration records<a class="hash-link" href="#compaction-configuration-records" title="Direct link to heading">​</a></h3><p>Druid retains all compaction configuration records by default, which should be suitable for most use cases.
If you create and delete short-lived datasources with high frequency, and you set auto compaction configuration on those datasources, then consider turning on automated cleanup of compaction configuration records.</p><blockquote><p>With automated cleanup of compaction configuration records, if you create a compaction configuration for some datasource before the datasource exists, for example if initial ingestion is still ongoing, Druid may remove the compaction configuration.
To prevent the configuration from being prematurely removed, wait for the datasource to be created before applying the compaction configuration to the datasource.</p></blockquote><p>Unlike other metadata records, compaction configuration records do not have a retention period set by <code>durationToRetain</code>. Druid deletes compaction configuration records at every cleanup cycle for inactive datasources, which do not have segments either used or unused.</p><p>Compaction configuration records in the <code>druid_config</code> table become eligible for deletion after all segments for the datasource have been killed by the kill task. Automated cleanup for compaction configuration requires a <a href="#kill-task">kill task</a>.</p><p>Compaction configuration cleanup uses the following configuration:</p><ul><li><code>druid.coordinator.kill.compaction.on</code>: When <code>true</code>, enables cleanup for compaction configuration records.</li><li><code>druid.coordinator.kill.compaction.period</code>: Defines the frequency in <a href="https://en.wikipedia.org/wiki/ISO_8601#Durations" target="_blank" rel="noopener noreferrer">ISO 8601 format</a> for the cleanup job to check for and delete eligible compaction configuration records. Defaults to <code>P1D</code>.</li></ul><blockquote><p>If you already have an extremely large compaction configuration, you may not be able to delete compaction configuration due to size limits with the audit log. In this case you can set <code>druid.audit.manager.maxPayloadSizeBytes</code> and <code>druid.audit.manager.skipNullField</code> to avoid the auditing issue. See <a href="/docs/configuration/#audit-logging">Audit logging</a>.</p></blockquote><h3 class="anchor anchorWithStickyNavbar_LWe7" id="datasource-records-created-by-supervisors">Datasource records created by supervisors<a class="hash-link" href="#datasource-records-created-by-supervisors" title="Direct link to heading">​</a></h3><p>Datasource records created by supervisors become eligible for deletion when the supervisor is terminated or does not exist in the <code>druid_supervisors</code> table and the <code>durationToRetain</code> time has passed since their creation.</p><p>Datasource cleanup uses the following configuration:</p><ul><li><code>druid.coordinator.kill.datasource.on</code>: When <code>true</code>, enables cleanup datasources created by supervisors.</li><li><code>druid.coordinator.kill.datasource.period</code>: Defines the frequency in <a href="https://en.wikipedia.org/wiki/ISO_8601#Durations" target="_blank" rel="noopener noreferrer">ISO 8601 format</a> for the cleanup job to check for and delete eligible datasource records. Defaults to <code>P1D</code>.</li><li><code>druid.coordinator.kill.datasource.durationToRetain</code>: Defines the retention period in <a href="https://en.wikipedia.org/wiki/ISO_8601#Durations" target="_blank" rel="noopener noreferrer">ISO 8601 format</a> after creation that datasource records become eligible for deletion.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="indexer-task-logs">Indexer task logs<a class="hash-link" href="#indexer-task-logs" title="Direct link to heading">​</a></h3><p>You can configure the Overlord to delete indexer task log metadata and the indexer task logs from local disk or from cloud storage.
Set these properties in the <code>overlord/runtime.properties</code> file.</p><p>Indexer task log cleanup on the Overlord uses the following configuration:</p><ul><li><code>druid.indexer.logs.kill.enabled</code>: When <code>true</code>, enables cleanup of task logs.</li><li><code>druid.indexer.logs.kill.durationToRetain</code>: Defines the length of time in milliseconds to retain task logs.</li><li><code>druid.indexer.logs.kill.initialDelay</code>: Defines the length of time in milliseconds after the Overlord starts before it executes its first job to kill task logs.</li><li><code>druid.indexer.logs.kill.delay</code>: The length of time in milliseconds between jobs to kill task logs.</li></ul><p>For more detail, see <a href="/docs/configuration/#task-logging">Task logging</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="disable-automated-metadata-cleanup">Disable automated metadata cleanup<a class="hash-link" href="#disable-automated-metadata-cleanup" title="Direct link to heading">​</a></h2><p>Druid automatically cleans up metadata records, excluding compaction configuration records and indexer task logs.
To disable automated metadata cleanup, set the following properties in the <code>coordinator/runtime.properties</code> file:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Keep unused segments</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">druid.coordinator.kill.on=false</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Keep audit records</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">druid.coordinator.kill.audit.on=false</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Keep supervisor records</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">druid.coordinator.kill.supervisor.on=false</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Keep rules records</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">druid.coordinator.kill.rule.on=false</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Keep datasource records created by supervisors</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">druid.coordinator.kill.datasource.on=false</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><a name="example"></a>## Example configuration for automated metadata cleanup<p>Consider a scenario where you have scripts to create and delete hundreds of datasources and related entities a day. You do not want to fill your metadata store with leftover records. The datasources and related entities tend to persist for only one or two days. Therefore, you want to run a cleanup job that identifies and removes leftover records that are at least four days old. The exception is for audit logs, which you need to retain for 30 days:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">...</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Schedule the metadata management store task for every hour:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">druid.coordinator.period.metadataStoreManagementPeriod=P1H</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Set a kill task to poll every day to delete Segment records and segments</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># in deep storage &gt; 4 days old. When druid.coordinator.kill.on is set to true,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># you can set killDataSourceWhitelist in the dynamic configuration to limit</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># the datasources that can be killed.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Required also for automated cleanup of rules and compaction configuration.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">druid.coordinator.kill.on=true</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">druid.coordinator.kill.period=P1D </span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">druid.coordinator.kill.durationToRetain=P4D</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">druid.coordinator.kill.maxSegments=1000</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Poll every day to delete audit records &gt; 30 days old</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">druid.coordinator.kill.audit.on=true</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">druid.coordinator.kill.audit.period=P1D</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">druid.coordinator.kill.audit.durationToRetain=P30D</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Poll every day to delete supervisor records &gt; 4 days old</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">druid.coordinator.kill.supervisor.on=true</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">druid.coordinator.kill.supervisor.period=P1D</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">druid.coordinator.kill.supervisor.durationToRetain=P4D</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Poll every day to delete rules records &gt; 4 days old</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">druid.coordinator.kill.rule.on=true</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">druid.coordinator.kill.rule.period=P1D</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">druid.coordinator.kill.rule.durationToRetain=P4D</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Poll every day to delete compaction configuration records</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">druid.coordinator.kill.compaction.on=true</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">druid.coordinator.kill.compaction.period=P1D</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Poll every day to delete datasource records created by supervisors &gt; 4 days old</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">druid.coordinator.kill.datasource.on=true</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">druid.coordinator.kill.datasource.period=P1D</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">druid.coordinator.kill.datasource.durationToRetain=P4D</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="learn-more">Learn more<a class="hash-link" href="#learn-more" title="Direct link to heading">​</a></h2><p>See the following topics for more information:</p><ul><li><a href="/docs/configuration/#metadata-management">Metadata management</a> for metadata store configuration reference.</li><li><a href="/docs/dependencies/metadata-storage">Metadata storage</a> for an overview of the metadata storage database.</li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/apache/druid/edit/master/docs/../docs/operations/clean-metadata-store.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2022-09-19T02:40:33.000Z">Sep 19, 2022</time></b> by <b>Vadim Ogievetsky</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/operations/http-compression"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">HTTP compression</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/operations/request-logging"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Request logging</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#automated-cleanup-strategies" class="table-of-contents__link toc-highlight">Automated cleanup strategies</a></li><li><a href="#configure-automated-metadata-cleanup" class="table-of-contents__link toc-highlight">Configure automated metadata cleanup</a><ul><li><a href="#audit-records" class="table-of-contents__link toc-highlight">Audit records</a></li><li><a href="#supervisor-records" class="table-of-contents__link toc-highlight">Supervisor records</a></li><li><a href="#rules-records" class="table-of-contents__link toc-highlight">Rules records</a></li><li><a href="#compaction-configuration-records" class="table-of-contents__link toc-highlight">Compaction configuration records</a></li><li><a href="#datasource-records-created-by-supervisors" class="table-of-contents__link toc-highlight">Datasource records created by supervisors</a></li><li><a href="#indexer-task-logs" class="table-of-contents__link toc-highlight">Indexer task logs</a></li></ul></li><li><a href="#disable-automated-metadata-cleanup" class="table-of-contents__link toc-highlight">Disable automated metadata cleanup</a></li><li><a href="#learn-more" class="table-of-contents__link toc-highlight">Learn more</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="margin-bottom--sm"><img src="/img/favicon.png" class="themedImage_ToTc themedImage--light_HNdA footer__logo"><img src="/img/favicon.png" class="themedImage_ToTc themedImage--dark_i4oU footer__logo"></div><div class="footer__copyright">Copyright © 2023 Apache Software Foundation</div></div></div></footer></div>
<script src="/assets/js/runtime~main.48cb3551.js"></script>
<script src="/assets/js/main.fe95e508.js"></script>
</body>
</html>